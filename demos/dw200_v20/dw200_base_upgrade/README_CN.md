# **DW200_V10 设备升级系统（基于 MQTT）**

> 本演示基于真实升级场景，展示 DW200_V20 在实际项目中的设备程序升级方案。网络配置仅为升级前的必要准备方式（支持扫码/手动），核心能力是“设备程序升级”。

## 演示概述

- 设备型号：DW200_V20（触摸屏一体机）
- 主要用途：作为“烧录机/升级器”安装和升级客户自研程序
- 通信协议：MQTT（远程管理与下发升级指令）

### 主要功能
- 设备程序烧录与升级（支持进度、版本校验与回滚）
- 批量升级（面向多设备统一下发）
- 远程管理与监控（MQTT 心跳、离线、结果上报）
- 网络配置（升级前准备，支持二维码与手动）

### 升级方式（前置网络已配置）
1. 扫码配置网络 → 接入 MQTT → 接收升级指令 → 自动下载并安装固件
2. 手动配置网络 → 接入 MQTT → 接收升级指令 → 自动下载并安装固件

## 核心功能

### 设备程序升级
- 固件下载：接收平台下发升级指令后自动下载
- 升级安装：本地校验与安装，显示进度
- 版本管理：版本比对与失败回滚
- 批量升级：面向设备组统一升级

### 网络配置（升级前准备）
- 二维码配置：扫码写入网络/MQTT 参数，增量更新，仅覆盖提供的字段
- 手动配置：触摸屏输入 IP/网关/DNS/MQTT 等参数，保存后生效

### 升级应用服务器
- 固件管理：上传、存储、版本管理固件文件
- 升级策略：支持单设备、批量设备升级策略配置
- 升级监控：实时监控升级进度、状态反馈
- 回滚机制：升级失败时自动回滚到上一版本

## 目录结构

```
├── src/
│   ├── view/            # UI 视图组件
│   │   ├── page/        # 主界面
│   │   ├── pinyin/      # 输入法组件
│   │   └── util/        # UI 工具
│   ├── service/         # 服务层
│   │   ├── codeService.js       # 二维码解析与配置写入
│   │   ├── mqttService.js       # MQTT 通信服务
│   │   └── netService.js        # 网络服务
│   ├── main.js          # 程序入口
│   ├── screen.js        # 屏幕管理
│   └── config.json      # 运行配置
├── server/              # 升级应用服务器
├── resource/            # 资源文件（字体、图片）
├── dxmodules/           # DX 框架模块
├── app.dxproj           # 项目配置文件
├── README.md            # 英文说明文档
└── README_CN.md         # 中文说明文档
```

## 代码架构

- 多线程：
  - 主线程：UI 刷新
  - 服务线程：二维码解析、MQTT 通信与耗时任务

## MQTT 通信协议

设备与平台的 MQTT 主题定义：

- 设备心跳上报（设备→平台）
  - 主题：`base_upgrade/v1/event/heart`
  - 消息：
    ```json
    { "uuid": "", "timestamp": "" }
    ```

- 设备离线上报（设备→平台）
  - 主题：`base_upgrade/v1/event/offline`
  - 消息：
    ```json
    { "uuid": "", "timestamp": "" }
    ```

- 升级命令（平台→设备）
  - 主题：`base_upgrade/v1/cmd/{uuid}/upgrade`
  - 消息：
    ```json
    { "serialNo": "00001", "url": "http://server/firmware.bin", "md5": "abc123def456", "timestamp": "2024-01-01T12:00:00Z" }
    ```

- 升级应答（设备→平台）
  - 主题：`base_upgrade/v1/cmd/upgrade_reply`
  - 消息：
    ```json
    { "type": "upgrade|config|status", "status": "success|failed", "message": "描述", "timestamp": "2024-01-01T12:00:00Z" }
    ```

## 扫码配置

- 配置码格式（JSON，仅示例字段，按需可选）：
  ```json
  {
    "net_type": 1,                // 1=以太网, 2=WiFi（如设备支持）
    "ssid": "WiFi名称",
    "psk": "WiFi密码",
    "dhcp": 1,                    // 1=自动, 2=手动
    "mqttAddr": "mqtt.example.com:1883",
    "username": "用户名",
    "password": "密码",
    "ip": "192.168.1.100",
    "mask": "255.255.255.0",
    "gateway": "192.168.1.1",
    "dns": "8.8.8.8"
  }
  ```

- 示例
  - WiFi：
    ```json
    { "net_type": 2, "ssid": "MyWiFi", "psk": "password123", "mqttAddr": "mqtt.example.com:1883" }
    ```
  - 以太网（静态 IP）：
    ```json
    { "net_type": 1, "dhcp": 2, "ip": "192.168.1.100", "mask": "255.255.255.0", "gateway": "192.168.1.1", "dns": "8.8.8.8", "mqttAddr": "mqtt.example.com:1883" }
    ```

## 配置

- MQTT：`src/config.json`
  ```json
  { "mqttAddr": "mqtt.example.com:1883", "username": "device_user", "password": "device_pass" }
  ```
- 网络：`src/config.json`
  ```json
  { "type": 1, "dhcp": 2, "ip": "192.168.1.100", "mask": "255.255.255.0", "gateway": "192.168.1.1", "dns": "8.8.8.8" }
  ```

## 升级服务器使用方法

### 环境要求
- Node.js 14.0 或更高版本
- npm 或 yarn 包管理器
- MQTT 服务器（如 Mosquitto、EMQ X 等）

### 服务器配置
1. **启动服务**：
   ```bash
   cd server
   npm install          # 安装依赖
   node index.js        # 启动服务器
   ```
2. **MQTT配置**：配置MQTT服务器地址和认证信息
3. **固件准备**：将升级固件文件命名为 `upgrade.dpk` 并放置在 `server/` 目录下
4. **设备管理**：添加和管理需要升级的设备

### 服务器配置说明
- **端口配置**：默认监听 3000 端口，可通过环境变量 `PORT` 修改
- **MQTT连接**：配置 `server/mqttConfig.js` 中的 MQTT 服务器信息
- **固件存储**：固件文件直接存储在 `server/` 目录下，文件名为 `upgrade.dpk`
- **日志记录**：日志文件保存在 `server/logs/` 目录下

### 升级流程
1. **设备连接**：设备通过MQTT发送心跳，服务器接收并展示在Web界面
2. **设备选择**：在Web界面中选择需要升级的目标设备
3. **发送升级指令**：向选中的设备发送升级命令
4. **监控进度**：实时查看设备升级状态和结果反馈

### 批量升级
- 支持按设备类型、区域、版本等条件分组
- 可配置升级时间窗口，避免影响业务
- 支持升级失败自动重试机制
- 提供升级报告和统计信息

## 使用场景

- 设备程序烧录：开发完成后统一安装部署
- 批量设备升级：按设备组下发升级
- 远程设备管理：在线监控、远程维护
- 网络配置（升级前准备）：出厂/现场快速配置、网络变更重配

## 故障排除

- 网络连接失败：检查 DHCP/静态 IP、网关与 DNS
- MQTT 连接失败：检查地址、账号密码、防火墙
- 扫码配置失败：检查 JSON 格式/二维码清晰度/权限与存储空间

## 安全考虑

- 传输安全：TLS/SSL、账号口令
- 数据安全：固件 MD5 校验、配置加密存储

---

注意：使用前请先完成网络与 MQTT 配置，再进行远程升级。
