# 门禁应用基础框架

## 1. 概述

本项目是一个用于开发门禁应用（尤其适用于嵌入式设备）的基础样板/框架。它提供了一个清晰、结构良好且事件驱动的架构，旨在方便地通过特定的业务逻辑进行扩展。

该框架的主要目标是处理 UI、设备硬件（NFC、条码扫描器）和网络通信（MQTT、NTP）的底层设置，让开发者能够专注于实现其门禁系统的核心功能，而无需重复“造轮子”。它有意地弱化了业务逻辑，仅提供结构基础。

### 1.1. 设备兼容性

虽然本应用目前主要针对 **DW200 V20** 设备进行了适配，但其核心的 JavaScript 代码具有高度的可移植性，可以运行在其他基于 `dejaos` 的设备上。要将此框架移植到新设备，主要需要进行以下调整：

- **适配 UI**: 修改 `src/view/` 目录下的屏幕布局和 UI 组件，以匹配目标设备的屏幕分辨率和硬件特性。
- **更新模块**: 确保使用了与目标硬件相对应的 `dxmodules`。

## 2. 核心特性

- **模块化与分层架构**: 将关注点清晰地分离到不同的层次（控制器、工作单元、服务、视图），使代码库易于理解、维护和扩展。
- **为扩展而设计**: 核心业务逻辑与输入/输出层和服务层解耦。您可以轻松地在 `worker` 目录中添加复杂的访问规则和行为，而无需重构整个应用。
- **事件驱动**: 利用中央事件总线 (`dxEventBus`) 在不同层之间进行通信，促进了松耦合和新功能的灵活集成。
- **抽象化服务**: 提供了一个清晰的服务层来与数据库、配置文件和硬件模块交互，隐藏了底层的实现细节。

## 3. 项目结构

本应用采用经典的分层架构进行组织。关于每个层职责的详细说明，请参阅各目录下的 `README.md` 文件。

- `src/`
  - `controller/`: **输入层** - 处理所有外部输入（UI 交互、MQTT 消息、设备硬件事件）。其唯一职责是接收输入并将其委托给相应的工作单元。
  - `worker/`: **业务逻辑层** - 这是您应用的核心。它包含处理事件、做出决策和管理应用状态的核心逻辑。**这是您需要重点修改和扩展的主要目录。**
  - `service/`: **服务层** - 提供基础的、可复用的服务，如数据库访问 (`sqlite.js`)、配置管理 (`config.js`) 和硬件通信 (`ble.js`)。
  - `view/`: **表现层** - 管理所有 UI 组件、屏幕和视觉元素。
  - `utils/`: **工具类** - 包含通用的、无状态的辅助函数（例如，日期格式化、字符串操作），可在整个应用中使用。

## 4. 如何使用与定制

这个框架是一个起点。要构建您的应用，您应该专注于在 **`src/worker/`** 目录内实现您的特定业务逻辑。

### 示例工作流:

假设您想实现一个规则：当扫描到有效条码时开门。

1.  **输入**: 条码被扫描。事件被 `src/controller/deviceController.js` 中的硬件监听器捕获。
2.  **委托**: `deviceController` 本身不做任何处理。它只是触发一个包含条码数据的事件，该事件由 `src/worker/deviceWorker.js` 监听。
3.  **业务逻辑 (您的工作)**: 在 `deviceWorker.js` 内部，您需要实现以下逻辑：
    - 条码格式是否有效？
    - 该条码是否对应一个有效的用户？（您可能会从 `service` 层调用 `sqlite.js` 来查询数据库）。
    - 该用户当前是否有权限进入？
    - 如果所有检查都通过，触发一个开门事件，并触发另一个事件以在 UI 上显示“成功”消息。
4.  **执行/反馈**: 其他模块（如 `uiController.js` 或 `deviceController.js` 的另一部分）监听“开门”和“显示成功”事件，并相应地执行操作。

通过遵循这种模式，您复杂的业务逻辑可以与底层的硬件和 UI 代码保持清晰的分离。
