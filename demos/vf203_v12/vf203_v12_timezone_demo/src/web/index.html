<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timezone Settings</title>
    <style>
      :root {
        --bg-color: #121212;
        --card-bg-color: #1e1e1e;
        --primary-color: #bb86fc;
        --secondary-color: #03dac6;
        --text-color: #e0e0e0;
        --text-secondary-color: #a0a0a0;
        --border-color: #333;
        --success-color: #4caf50;
        --error-color: #f44336;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      .container {
        width: 100%;
        max-width: 800px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      header {
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      h1 {
        color: var(--primary-color);
        margin: 0;
      }

      h2 {
        color: var(--secondary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        margin-top: 0;
      }

      .card {
        background-color: var(--card-bg-color);
        border-radius: 8px;
        padding: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }

      .time-display {
        font-size: 2.5em;
        font-family: "Courier New", Courier, monospace;
        text-align: center;
        padding: 20px;
        background-color: #2c2c2c;
        border-radius: 8px;
        border: 2px solid var(--primary-color);
        margin: 20px 0;
        color: var(--primary-color);
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: var(--text-secondary-color);
      }

      select {
        width: 100%;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background-color: #2c2c2c;
        color: var(--text-color);
        box-sizing: border-box;
        font-size: 1em;
      }

      select:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      button {
        padding: 12px 24px;
        border-radius: 4px;
        border: none;
        color: #ffffff;
        background-color: var(--success-color);
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
        width: 100%;
        margin-top: 10px;
      }

      button:hover {
        opacity: 0.9;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 25px;
        border-radius: 8px;
        color: #fff;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
      }

      #toast.show {
        opacity: 1;
        visibility: visible;
      }

      #toast.success {
        background-color: var(--success-color);
      }
      #toast.error {
        background-color: var(--error-color);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Timezone Settings</h1>
      </header>

      <main>
        <div class="card">
          <h2>Current Time</h2>
          <div class="time-display" id="current-time">Loading...</div>
        </div>

        <div class="card">
          <h2>Select Timezone</h2>
          <div class="form-group">
            <label for="timezone-select">Choose a timezone:</label>
            <select id="timezone-select">
              <option value="">Loading timezones...</option>
            </select>
          </div>
          <button id="apply-timezone">Apply & Reboot</button>
        </div>
      </main>
    </div>

    <div id="toast"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toast = document.getElementById("toast");
        let toastTimer;

        function showToast(message, type = "success", duration = 3000) {
          clearTimeout(toastTimer);
          toast.textContent = message;
          toast.className = ``;
          toast.classList.add(type, "show");
          toastTimer = setTimeout(() => {
            toast.classList.remove("show");
          }, duration);
        }

        async function apiRequest(endpoint, options = {}) {
          try {
            const response = await fetch(endpoint, options);
            const result = await response.json();

            if (result.code !== 0) {
              throw new Error(result.message || "An unknown error occurred");
            }

            return result.data || result.message;
          } catch (error) {
            console.error("API Request Failed:", error);
            showToast(error.message, "error");
            throw error;
          }
        }

        // Update current time
        async function updateCurrentTime() {
          try {
            const data = await apiRequest("/api/current-time");
            document.getElementById("current-time").textContent = data.time;
          } catch (error) {
            document.getElementById("current-time").textContent = "Error loading time";
          }
        }

        // Load timezones
        async function loadTimezones() {
          const select = document.getElementById("timezone-select");
          try {
            const timezones = await apiRequest("/api/timezones?lang=en");
            select.innerHTML = "";
            
            Object.entries(timezones).forEach(([key, tz]) => {
              const option = document.createElement("option");
              option.value = key;
              option.textContent = `${tz.name} (${tz.utc_offset})`;
              select.appendChild(option);
            });
          } catch (error) {
            select.innerHTML = '<option value="">Failed to load timezones</option>';
          }
        }

        // Apply timezone
        document.getElementById("apply-timezone").addEventListener("click", async () => {
          const select = document.getElementById("timezone-select");
          const timezone = select.value;
          
          if (!timezone) {
            showToast("Please select a timezone", "error");
            return;
          }

          const button = document.getElementById("apply-timezone");
          button.disabled = true;
          button.textContent = "Applying...";

          try {
            const message = await apiRequest("/api/update-timezone", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ timezone }),
            });
            showToast(message, "success", 5000);
            button.textContent = "Rebooting...";
          } catch (error) {
            button.disabled = false;
            button.textContent = "Apply & Reboot";
          }
        });

        // Update time every second
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // Load timezones on page load
        loadTimezones();
      });
    </script>
  </body>
</html>